{% extends 'base.html' %}

{% block content %}
    <div class="content-section">
        <div class="pdf landscape">
            {% if report == 'NSSF' %}
                {% include 'reports/generated_nssf_report.html' %}
            {% elif report == 'LST' %}
                {% include 'reports/generated_lst_report.html' %}
            {% elif report == 'LEGER_EXPORT' %}
                {% include 'reports/generated_leger_report.html' %}
            {% elif report == 'SUMMARY' %}
                {% include 'reports/generated_summary_report.html' %}
            {% elif report == 'PAYE' %}
                {% include 'reports/generated_paye_report.html' %}
            {% elif report == 'Pay Slip' %}
                {% include 'reports/generated_payslip_report.html' %}
            {% elif report == 'BANK' %}
                {% include 'reports/generated_bank_report.html' %}
            {% endif %}
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    <script>
        $(document).ready(function() {
            $('#table_id').DataTable( {
                dom: 'lBfrtip',
                scrollX: true,
                scrollCollapse: true,
                autoWidth: true,
                paging: true,
                buttons: [
                    'copy', 'csv', 'excel',
                    {
                        extend: 'pdfHtml5',
                    },
                    'print'
                ]
            } );

            let lst_table = $('#lst_table_id').DataTable( {
                dom: 'lBfrtip',
                scrollX: true,
                scrollCollapse: true,
                autoWidth: true,
                paging: true,
                buttons: [
                    'copy', 'csv', 'excel',
                    {
                        extend: 'pdfHtml5',
                    },
                    'print'
                ],

                "footerCallback": function ( row, data, start, end, display ) {
                    var api = this.api(), data;

                    let colCount = api.columns().header().length;

                    // Remove the formatting to get integer data for summation
                    let intVal = function ( i ) {
                        return typeof i === 'string' ?
                            i.replace(/[\$,]/g, '')*1 :
                            typeof i === 'number' ?
                                i : 0;
                    };

                    let i;
                    let pageTotal = [];
                    for (i = 0; i < colCount; i++) {
                        // Total over this page
                        if (i > 2) {
                            pageTotal[i] = api
                                .column( i, { page: 'current'} )
                                .data()
                                .reduce( function (a, b) {
                                    return Math.round((intVal(a) + intVal(b))* 100) / 100;
                                }, 0 );
                        }
                    }

                    for (i = 0; i < colCount; i++) {
                        // Update footer
                        if (i > 2) {
                            $( api.column( i ).footer() ).html(
                                pageTotal[i].toLocaleString()
                            );
                        }
                    }
                }
            } );

            let id = $('.payroll_period').attr('id');
            let period_month = document.getElementById(id).innerHTML;
            console.log(period_month);

            let summaryReportTable = $('#summary_id').DataTable( {
                orderCellsTop: true,
                fixedHeader: true,
                dom: 'lBfrtip',
                scrollX: true,
                scrollCollapse: true,
                autoWidth: true,
                paging: true,
                buttons: [
                    'selectAll',
                    'selectNone',
                    {
                        extend: 'copyHtml5',
                        footer: true
                    },
                    {
                        extend: 'csv',
                        footer: true
                    },
                    {
                        extend: 'excel',
                        footer: true
                    },
                    {
                        extend: 'pdfHtml5',
                        orientation: 'landscape',
                        pageSize: 'A2',
                        footer: true,
                        filename: 'summary_report',
                        title: 'SAVE THE CHILDREN\n' +
                            'PAYROLL FOR THE MONTH OF ' + period_month,
                        messageBottom: '\n\n\n\n\nPrepared By..................................................................' +
                            '\tChecked By........................................................' +
                            '\tApproved By..................................................'
                    },
                    {
                        extend: 'print',
                        orientation: 'landscape',
                        pageSize: 'A2',
                        footer: true
                    },
                ],
                "footerCallback": function ( row, data, start, end, display ) {
                    var api = this.api(), data;

                    let colCount = api.columns().header().length;

                    // Remove the formatting to get integer data for summation
                    let intVal = function ( i ) {
                        return typeof i === 'string' ?
                            i.replace(/[\$,]/g, '')*1 :
                            typeof i === 'number' ?
                                i : 0;
                    };

                    let i;
                    let pageTotal = [];
                    for (i = 0; i < colCount; i++) {
                        // Total over this page
                        if (i > 5 && i < colCount-1) {
                            pageTotal[i] = api
                                .column( i, { page: 'current'} )
                                .data()
                                .reduce( function (a, b) {
                                    return Math.round((intVal(a) + intVal(b))* 100) / 100;
                                }, 0 );
                        }
                    }

                    for (i = 0; i < colCount; i++) {
                        // Update footer
                        if (i > 5 && i < colCount-1) {
                            $( api.column( i ).footer() ).html(
                                pageTotal[i].toLocaleString()
                            );
                        }
                    }
                }
            } );

            $('#summary_id tbody').on( 'click', 'tr', function () {
                $(this).toggleClass('selected');
            } );

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    let cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            let csrftoken = getCookie('csrftoken');

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            $('#send_mail').click( function () {
                console.log( summaryReportTable.rows('.selected').data().length +' Employee(s) selected for Payslip mailing' );
                let payroll_period = $('.payroll_period').attr('id');
                let length = summaryReportTable.rows('.selected').data().length;
                alert(length + ' Staff will be emailed there payslips. Would you like to continue?');
                let users = [];
                let i;
                for (i = 0; i < length; i++) {
                    users.push(summaryReportTable.rows('.selected').data()[i][1])
                }

                emailUrl = '/reports/email/payslips/';
                let users_data = {
                    'users': users,
                    'payroll_period': payroll_period
                };
                $.post(emailUrl, users_data, function (response) {
                    if (response.status === 'success') {
                        alert('Emails have been successfully sent')
                    }
                });
            } );
        } );
    </script>
{% endblock scripts %}